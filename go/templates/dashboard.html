<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Access Logs Dashboard</title>
        <link rel="stylesheet" href="/static/css/catpuccin.css" />
        <style>
            body {
                margin: 0;
                padding: 20px;
                background-color: var(--ctp-latte-base);
                color: var(--ctp-latte-text);
            }
            .container {
                max-width: 1200px;
                margin: 0 auto;
            }
            .controls {
                text-align: center;
                margin-bottom: 30px;
                background: var(--ctp-latte-crust);
                padding: 20px;
            }
            .dashboard-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
                gap: 20px;
                margin-bottom: 20px;
            }
            .card {
                background: var(--ctp-latte-mantle);
                padding: 20px;
            }
            .card h2 {
                margin-top: 0;
                color: var(--ctp-latte-text);
                font-size: 18px;
                border-bottom: 2px solid var(--ctp-latte-overlay0);
                padding-bottom: 10px;
            }
            .metric-list {
                max-height: 400px;
                overflow-y: scroll;
            }
            .metric-item {
                display: flex;
                justify-content: space-between;
                padding: 8px 0;
                border-bottom: 1px solid var(--ctp-latte-overlay0);
            }
            .metric-item:last-child {
                border-bottom: none;
            }
            .metric-label {
                flex: 1;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                margin-right: 10px;
                font-family: monospace;
                font-size: 13px;
            }
            .metric-label.clickable {
                color: var(--ctp-latte-blue);
                cursor: pointer;
                text-decoration: underline;
            }
            .metric-label.clickable:hover {
                color: var(--ctp-latte-sapphire);
            }
            .metric-value {
                font-weight: bold;
                color: var(--ctp-latte-blue);
                min-width: 60px;
                text-align: right;
                margin-right: 10px;
            }
            .error-metric .metric-value {
                color: var(--ctp-latte-red);
            }
            .loading {
                text-align: center;
                padding: 40px;
                color: var(--ctp-latte-subtext0);
            }
            .error {
                text-align: center;
                padding: 40px;
                color: var(--ctp-latte-red);
                background: var(--ctp-latte-mantle);
                margin: 20px 0;
            }
            .stats-summary {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin-bottom: 30px;
            }
            .stat-box {
                background: var(--ctp-latte-mantle);
                padding: 20px;
                text-align: center;
            }
            .stat-number {
                font-size: 24px;
                font-weight: bold;
                color: var(--ctp-latte-text);
            }
            .stat-label {
                font-size: 12px;
                color: var(--ctp-latte-subtext0);
                margin-top: 5px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="controls">
                <label for="timePeriod">Time Period:</label>
                <select id="timePeriod">
                    <option value="1h">Last Hour</option>
                    <option value="24h" selected>Last 24 Hours</option>
                    <option value="7d">Last 7 Days</option>
                    <option value="30d">Last 30 Days</option>
                </select>
                <button onclick="refreshDashboard()">Refresh</button>
            </div>

            <div class="stats-summary" id="statsSummary">
                <div class="stat-box">
                    <div class="stat-number" id="totalRequests">-</div>
                    <div class="stat-label">Total Requests</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="uniqueIPs">-</div>
                    <div class="stat-label">Unique IPs</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="errorRate">-</div>
                    <div class="stat-label">Error Rate (%)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="avgResponseTime">-</div>
                    <div class="stat-label">Avg Response (ms)</div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="card">
                    <h2>Top 100 IP Addresses</h2>
                    <div id="topIPs" class="metric-list">
                        <div class="loading">Loading...</div>
                    </div>
                </div>

                <div class="card">
                    <h2>Most Requested Routes</h2>
                    <div id="topRoutes" class="metric-list">
                        <div class="loading">Loading...</div>
                    </div>
                </div>

                <div class="card">
                    <h2>IPs with Most 404s</h2>
                    <div id="bot404s" class="metric-list">
                        <div class="loading">Loading...</div>
                    </div>
                </div>

                <div class="card">
                    <h2>Errors</h2>
                    <div id="errorCodes" class="metric-list">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            async function fetchDashboardData() {
                const timePeriod = document.getElementById("timePeriod").value;

                try {
                    const response = await fetch(
                        `/api/dashboard?period=${timePeriod}`,
                    );
                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }
                    const data = await response.json();
                    updateDashboard(data);
                } catch (error) {
                    console.error("Error fetching dashboard data:", error);
                    showError(
                        "Failed to load dashboard data. Please try again.",
                    );
                }
            }

            function updateDashboard(data) {
                document.getElementById("totalRequests").textContent =
                    data.stats.totalRequests.toLocaleString();
                document.getElementById("uniqueIPs").textContent =
                    data.stats.uniqueIPs.toLocaleString();
                document.getElementById("errorRate").textContent =
                    data.stats.errorRate.toFixed(1);
                document.getElementById("avgResponseTime").textContent =
                    Math.round(data.stats.avgResponseTime);

                updateMetricList(
                    "topIPs",
                    data.topIPs,
                    (item) => ({
                        label: item.ip,
                        value: item.count.toLocaleString(),
                    }),
                    false,
                    true,
                );

                updateMetricList("topRoutes", data.topRoutes, (item) => ({
                    label: item.url,
                    value: item.count.toLocaleString(),
                }));

                updateMetricList(
                    "bot404s",
                    data.bot404s,
                    (item) => ({
                        label: item.ip,
                        value: item.count.toLocaleString(),
                    }),
                    true,
                    true,
                );

                updateMetricList(
                    "errorCodes",
                    data.errorCodes,
                    (item) => ({
                        label: `${item.status_code} - ${getStatusText(item.status_code)}`,
                        value: item.count.toLocaleString(),
                    }),
                    true,
                );
            }

            function updateMetricList(
                elementId,
                data,
                formatter,
                isError = false,
                clickableIPs = false,
            ) {
                const element = document.getElementById(elementId);
                if (!data || data.length === 0) {
                    element.innerHTML =
                        '<div class="loading">No data available</div>';
                    return;
                }

                const html = data
                    .map((item) => {
                        const formatted = formatter(item);
                        const errorClass = isError ? "error-metric" : "";
                        const clickableClass = clickableIPs ? "clickable" : "";
                        const onClick = clickableIPs
                            ? `onclick="window.location.href='/dashboard/ip/${encodeURIComponent(formatted.label)}'"`
                            : "";
                        return `
                    <div class="metric-item ${errorClass}">
                        <div class="metric-label ${clickableClass}" title="${formatted.label}" ${onClick}>${formatted.label}</div>
                        <div class="metric-value">${formatted.value}</div>
                    </div>
                `;
                    })
                    .join("");

                element.innerHTML = html;
            }

            function getStatusText(statusCode) {
                const statusTexts = {
                    400: "Bad Request",
                    401: "Unauthorized",
                    403: "Forbidden",
                    404: "Not Found",
                    405: "Method Not Allowed",
                    429: "Too Many Requests",
                    500: "Internal Server Error",
                    502: "Bad Gateway",
                    503: "Service Unavailable",
                };
                return statusTexts[statusCode] || "Unknown";
            }

            function showError(message) {
                const elements = [
                    "topIPs",
                    "topRoutes",
                    "bot404s",
                    "errorCodes",
                ];
                elements.forEach((id) => {
                    document.getElementById(id).innerHTML =
                        `<div class="error">${message}</div>`;
                });
            }

            function refreshDashboard() {
                const elements = [
                    "topIPs",
                    "topRoutes",
                    "bot404s",
                    "errorCodes",
                ];
                elements.forEach((id) => {
                    document.getElementById(id).innerHTML =
                        '<div class="loading">Loading...</div>';
                });

                [
                    "totalRequests",
                    "uniqueIPs",
                    "errorRate",
                    "avgResponseTime",
                ].forEach((id) => {
                    document.getElementById(id).textContent = "-";
                });

                fetchDashboardData();
            }

            setInterval(refreshDashboard, 30000);

            document.addEventListener("DOMContentLoaded", fetchDashboardData);
        </script>
    </body>
</html>
